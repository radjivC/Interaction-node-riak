createClient = require('riakpbc').createClient
createModel = require('../src').createModel


client = createClient()

client.setClientId client_id: 'testclient', (reply) ->
  throw reply.errmsg if reply.errmsg

  Book = createModel
    name: 'Book'
    bucket: 'books'
    connection: client
    schema:
      properties:
        title:
          type: 'string'
          required: true

  props =
    bucket: 'books'
    props:
      allow_mult: true

  client.setBucket props, (reply) ->
    throw err if reply.errmsg
    console.log 'bucket allows now multiple versions'

    book = Book.create(title: 'test')

    book.put (err) ->
      throw err if err

      Book.get book.key, (err, book) ->
        console.log 3
        throw err if err
        book.del (err) ->
          console.log 4
          throw err if err
          console.log 'deleted: ' + book.key

          Book.get book.key, (err, book) ->
            console.log 5
            console.log 'book get:', err, null
